<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>

<!-- Mirrored from localhost:8080/SciPyPackages/NumExpr?highlight=%28%28Weave%29%29 by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 29 Oct 2015 23:20:36 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
<meta name="edit_on_doubleclick" content="/">
<meta name="robots" content="noindex,nofollow">

<title>SciPyPackages/NumExpr - SciPy wiki dump</title>
<script type="text/javascript" src="../moin_static197/common/js/common.js"></script>

<script type="text/javascript">
<!--
var search_hint = "Search";
//-->
</script>


<link rel="stylesheet" type="text/css" charset="utf-8" media="all" href="../moin_static197/modern/css/common.css">
<link rel="stylesheet" type="text/css" charset="utf-8" media="screen" href="../moin_static197/modern/css/screen.css">
<link rel="stylesheet" type="text/css" charset="utf-8" media="print" href="../moin_static197/modern/css/print.css">
<link rel="stylesheet" type="text/css" charset="utf-8" media="projection" href="../moin_static197/modern/css/projection.css">

<!-- css only for MS IE6/IE7 browsers -->
<!--[if lt IE 8]>
   <link rel="stylesheet" type="text/css" charset="utf-8" media="all" href="/moin_static197/modern/css/msie.css">
<![endif]-->


<link rel="alternate" title="SciPy: SciPyPackages/NumExpr" href="../../external.html?link=http://localhost:8080/SciPyPackages/NumExpr?diffs=1&amp;show_att=1&amp;action=rss_rc&amp;unique=0&amp;page=SciPyPackages%2FNumExpr&amp;ddiffs=1" type="application/rss+xml">


<link rel="Start" href="../AllPages.html">
<link rel="Alternate" title="Wiki Markup" href="../../external.html?link=http://localhost:8080/SciPyPackages/NumExpr?action=raw">
<link rel="Alternate" media="print" title="Print View" href="../../external.html?link=http://localhost:8080/SciPyPackages/NumExpr?action=print">
<link rel="Up" href="../SciPyPackages.html">
<link rel="Search" href="../FindPage.html">
<link rel="Index" href="../TitleIndex.html">
<link rel="Glossary" href="../WordIndex.html">
<link rel="Help" href="../HelpOnFormatting.html">
</head>

<body  lang="en" dir="ltr"><div style="background: white; width:100%; padding:2em;">This is an archival dump of old wiki content --- see <a href="http://scipy.org/">scipy.org</a> for current material</div>

<div id="header">


<form id="searchform" method="get" action="../../external.html?link=http://localhost:8080/SciPyPackages/NumExpr">
<div>
<input type="hidden" name="action" value="fullsearch">
<input type="hidden" name="context" value="180">
<label for="searchinput">Search:</label>
<input id="searchinput" type="text" name="value" value="" size="20"
    onfocus="searchFocus(this)" onblur="searchBlur(this)"
    onkeyup="searchChange(this)" onchange="searchChange(this)" alt="Search">
<input id="titlesearch" name="titlesearch" type="submit"
    value="Titles" alt="Search Titles">
<input id="fullsearch" name="fullsearch" type="submit"
    value="Text" alt="Search Full Text">
</div>
</form>
<script type="text/javascript">
<!--// Initialize search form
var f = document.getElementById('searchform');
f.getElementsByTagName('label')[0].style.display = 'none';
var e = document.getElementById('searchinput');
searchChange(e);
searchBlur(e);
//-->
</script>

<ul id="username"><li><a href="NumExpr456e.html?action=login" id="login" rel="nofollow">Login</a></li></ul>
<div id="locationline">
<div id="interwiki"><span><a href="../AllPages.html" rel="nofollow">SciPy</a></span></div>

<ul id="pagelocation">
<li><a href="../SciPyPackages.html">SciPyPackages</a></li><li><a class="backlink" href="NumExpr45d2.html?action=fullsearch&amp;context=180&amp;value=linkto%3A%22SciPyPackages%2FNumExpr%22" rel="nofollow" title="Click to do a full-text search for this title">NumExpr</a></li>
</ul>

</div>


<ul id="navibar">
<li class="wikilink"><a href="../RecentChanges.html">RecentChanges</a></li><li class="wikilink"><a class="nonexistent" href="../FindPage.html">FindPage</a></li><li class="wikilink"><a class="nonexistent" href="../HelpContents.html">HelpContents</a></li><li class="current"><a href="NumExpr.html">SciPyPackages/NumExpr</a></li>
</ul>

<div id="pageline"><hr style="display:none;"></div>

<ul class="editbar"><li class="toggleCommentsButton" style="display:none;"><a href="#" class="nbcomment" onClick="toggleComments();return false;">Comments</a></li><li><a class="nbattachments" href="NumExpr37dc.html?action=AttachFile" rel="nofollow">Attachments</a></li><li>
<form class="actionsmenu" method="GET" action="../../external.html?link=http://localhost:8080/SciPyPackages/NumExpr">
<div>
    <label>More Actions:</label>
    <select name="action"
        onchange="if ((this.selectedIndex != 0) &&
                      (this.options[this.selectedIndex].disabled == false)) {
                this.form.submit();
            }
            this.selectedIndex = 0;">
        <option value="show" disabled class="disabled">------------------------</option>
<option value="show" disabled class="disabled">------------------------</option>
<option value="RenamePage" disabled class="disabled">Rename Page</option>
<option value="DeletePage" disabled class="disabled">Delete Page</option>
<option value="show" disabled class="disabled">------------------------</option>
<option value="show" disabled class="disabled">Subscribe User</option>
<option value="show" disabled class="disabled">------------------------</option>
<option value="show" disabled class="disabled">Remove Spam</option>
<option value="show" disabled class="disabled">Revert to this revision</option>
    </select>
    <input type="submit" value="Do">
    
</div>
<script type="text/javascript">
<!--// Init menu
actionsMenuInit('More Actions:');
//-->
</script>
</form>
</li></ul>

</div>

<div id="page" lang="en" dir="ltr">
<div dir="ltr" id="content" lang="en"><span class="anchor" id="top"></span>
<span class="anchor" id="line-1"></span><p class="line867">
<h2 id="Description">Description</h2>
<span class="anchor" id="line-2"></span><p class="line862">The <tt class="backtick">numexpr</tt> package supplies routines for the fast evaluation of array expressions elementwise by using a vector-based virtual machine. It's comparable to <tt class="backtick">scipy.<strong class="highlight">weave</strong>.blitz</tt> (in <a href="../Weave.html"><strong class="highlight">Weave</strong></a>), but doesn't require a separate compile step of C or C++ code. <span class="anchor" id="line-3"></span><span class="anchor" id="line-4"></span><p class="line867">
<h2 id="Building">Building</h2>
<span class="anchor" id="line-5"></span><p class="line862">The project is hosted <a class="http" href="../../external.html?link=http://code.google.com/p/numexpr/wiki/Overview">here</a>. <span class="anchor" id="line-6"></span><span class="anchor" id="line-7"></span><p class="line862">To use it as a standalone package, you can grab it from the Subversion repository at <a class="http" href="../../external.html?link=http://numexpr.googlecode.com/svn/trunk/">http://numexpr.googlecode.com/svn/trunk/</a>, and do the usual <tt class="backtick">python&nbsp;setup.py&nbsp;install</tt>. You will need <a class="nonexistent" href="../NumPy.html">NumPy</a> installed. <span class="anchor" id="line-8"></span><span class="anchor" id="line-9"></span><p class="line867">
<h2 id="Using">Using</h2>
<span class="anchor" id="line-10"></span><p class="line862">The main routine to be concerned with is <tt class="backtick">numexpr.evaluate</tt>. It acts like this: <span class="anchor" id="line-11"></span><span class="anchor" id="line-12"></span><p class="line867"><span class="anchor" id="line-13"></span><span class="anchor" id="line-14"></span><span class="anchor" id="line-15"></span><span class="anchor" id="line-16"></span><span class="anchor" id="line-17"></span><span class="anchor" id="line-18"></span><span class="anchor" id="line-19"></span><span class="anchor" id="line-1-1"></span><div class="highlight python"><div class="codearea" dir="ltr" lang="en"><pre dir="ltr" id="CA-985b1f1be0eb27187ae1b5f3987f70410dd976f9" lang="en"><span class="line"><span class="anchor" id="line-1-2"></span>&gt;&gt;&gt; <span class="ResWord">from</span> <span class="ID">numexpr</span> <span class="ResWord">import</span> <span class="ID">evaluate</span></span>
<span class="line"><span class="anchor" id="line-2-1"></span>&gt;&gt;&gt; <span class="ID">a</span> = <span class="ID">arange</span>(<span class="Number">10</span>)</span>
<span class="line"><span class="anchor" id="line-3-1"></span>&gt;&gt;&gt; <span class="ID">b</span> = <span class="ID">arange</span>(<span class="Number">0</span>,<span class="Number">20</span>,<span class="Number">2</span>)</span>
<span class="line"><span class="anchor" id="line-4-1"></span>&gt;&gt;&gt; <span class="ID">evaluate</span>(<span class="String">&quot;</span><span class="String">a+b</span><span class="String">&quot;</span>)</span>
<span class="line"><span class="anchor" id="line-5-1"></span><span class="ID">array</span>([ <span class="Number">0</span>,  <span class="Number">3</span>,  <span class="Number">6</span>,  <span class="Number">9</span>, <span class="Number">12</span>, <span class="Number">15</span>, <span class="Number">18</span>, <span class="Number">21</span>, <span class="Number">24</span>, <span class="Number">27</span>])</span>
</pre></div></div><span class="anchor" id="line-20"></span><p class="line862">The full signature of <tt class="backtick">evaluate</tt> is <tt class="backtick">evaluate(ex,&nbsp;local_dict=None,&nbsp;global_dict=None,&nbsp;**kwargs)</tt>. <tt class="backtick">ex</tt> is a string forming an expression, like &quot;<tt class="backtick">2*a+3*b</tt>&quot;. The values for <tt class="backtick">a</tt> and <tt class="backtick">b</tt> will by default be taken from the calling function's frame (through the use of <tt class="backtick">sys._getframe()</tt>). Alternatively, they can be specified using the <tt class="backtick">local_dict</tt> or global_dict` arguments, or passed as keyword arguments. <span class="anchor" id="line-21"></span><span class="anchor" id="line-22"></span><p class="line874">Expressions are cached, so reuse is fast. Arrays or scalars are allowed for the variables, which must be of type int, float64 (double), or complex128 (double,double). The arrays must all be the same size. <span class="anchor" id="line-23"></span><span class="anchor" id="line-24"></span><p class="line867">
<h2 id="How_it_works">How it works</h2>
<span class="anchor" id="line-25"></span><p class="line862">The string passed to <tt class="backtick">evaluate</tt> is compiled into an object representing the expression and types of the arrays used by the function <tt class="backtick">numexpr</tt>. <span class="anchor" id="line-26"></span><span class="anchor" id="line-27"></span><p class="line862">The expression is first compiled using Python's <tt class="backtick">compile</tt> function (this means that the expressions have to be valid Python expressions). From this, the variable names can be taken. The expression is then evaluated using instances of a special object that keep track of what is being done to them, and which builds up the parse tree of the expression. <span class="anchor" id="line-28"></span><span class="anchor" id="line-29"></span><p class="line862">This parse tree is then compiled to a bytecode program, which describes how to perform the operation elementwise. The virtual machine uses &quot;vector registers&quot;: each register is many elements wide (by default, the first pass uses 128 elements). The key to <tt class="backtick">numexpr</tt>'s speed is handling chunks of elements at a time. <span class="anchor" id="line-30"></span><span class="anchor" id="line-31"></span><p class="line862">There are two extremes to evaluating an expression elementwise. You can do each operation as arrays, returning temporary arrays. This is what you do when you use <a class="nonexistent" href="../NumPy.html">NumPy</a>: <tt class="backtick">2*a+3*b</tt> uses three temporary arrays as large as <tt class="backtick">a</tt> or <tt class="backtick">b</tt>. This strategy wastes memory (a problem if your arrays are large), and also is not a good use of cache memory: for large arrays, the results of <tt class="backtick">2*a</tt> and <tt class="backtick">3*b</tt> won't be in cache when you do the add. <span class="anchor" id="line-32"></span><span class="anchor" id="line-33"></span><p class="line874">The other extreme is to loop over each element, as in <span class="anchor" id="line-34"></span><span class="anchor" id="line-35"></span><p class="line867"><span class="anchor" id="line-36"></span><span class="anchor" id="line-37"></span><span class="anchor" id="line-38"></span><span class="anchor" id="line-39"></span><span class="anchor" id="line-1-3"></span><div class="highlight python"><div class="codearea" dir="ltr" lang="en"><pre dir="ltr" id="CA-1cc0226f867a32ba40b53079b064730237c5027a" lang="en"><span class="line"><span class="anchor" id="line-1-4"></span><span class="ResWord">for</span> <span class="ID">i</span> <span class="ResWord">in</span> <span class="ResWord">xrange</span>(<span class="ResWord">len</span>(<span class="ID">a</span>)):</span>
<span class="line"><span class="anchor" id="line-2-2"></span>    <span class="ID">c</span>[<span class="ID">i</span>] = <span class="Number">2</span>*<span class="ID">a</span>[<span class="ID">i</span>] + <span class="Number">3</span>*<span class="ID">b</span>[<span class="ID">i</span>]</span>
</pre></div></div><span class="anchor" id="line-40"></span><p class="line874">This doesn't consume extra memory, and is good for the cache, but, if the expression is not compiled to machine code, you will have a big case statement (or a bunch of if's) inside the loop, which adds a large overhead for each element, and will hurt the branch-prediction used on the CPU. <span class="anchor" id="line-41"></span><span class="anchor" id="line-42"></span><p class="line867"><tt class="backtick">numexpr</tt> uses a in-between approach. Arrays are handled as chunks (the first pass uses 128 elements) at a time, using a register machine. As Python code, it looks something like this: <span class="anchor" id="line-43"></span><span class="anchor" id="line-44"></span><p class="line867"><span class="anchor" id="line-45"></span><span class="anchor" id="line-46"></span><span class="anchor" id="line-47"></span><span class="anchor" id="line-48"></span><span class="anchor" id="line-49"></span><span class="anchor" id="line-50"></span><span class="anchor" id="line-51"></span><span class="anchor" id="line-52"></span><span class="anchor" id="line-53"></span><span class="anchor" id="line-1-5"></span><div class="highlight python"><div class="codearea" dir="ltr" lang="en"><pre dir="ltr" id="CA-e6fa9a4052ebdb6eac2a9004a2517c31464e92d8" lang="en"><span class="line"><span class="anchor" id="line-1-6"></span><span class="ResWord">for</span> <span class="ID">i</span> <span class="ResWord">in</span> <span class="ResWord">xrange</span>(<span class="Number">0</span>, <span class="ResWord">len</span>(<span class="ID">a</span>), <span class="Number">128</span>):</span>
<span class="line"><span class="anchor" id="line-2-3"></span>    <span class="ID">r0</span> = <span class="ID">a</span>[<span class="ID">i</span>:<span class="ID">i</span>+<span class="Number">128</span>]</span>
<span class="line"><span class="anchor" id="line-3-2"></span>    <span class="ID">r1</span> = <span class="ID">b</span>[<span class="ID">i</span>:<span class="ID">i</span>+<span class="Number">128</span>]</span>
<span class="line"><span class="anchor" id="line-4-2"></span>    <span class="ID">multiply</span>(<span class="ID">r0</span>, <span class="Number">2</span>, <span class="ID">r2</span>)</span>
<span class="line"><span class="anchor" id="line-5-2"></span>    <span class="ID">multiply</span>(<span class="ID">r1</span>, <span class="Number">3</span>, <span class="ID">r3</span>)</span>
<span class="line"><span class="anchor" id="line-6-1"></span>    <span class="ID">add</span>(<span class="ID">r2</span>, <span class="ID">r3</span>, <span class="ID">r2</span>)</span>
<span class="line"><span class="anchor" id="line-7-1"></span>    <span class="ID">c</span>[<span class="ID">i</span>:<span class="ID">i</span>+<span class="Number">128</span>] = <span class="ID">r2</span></span>
</pre></div></div><span class="anchor" id="line-54"></span><p class="line874">(remember that the 3-arg form stores the result in the third argument, instead of allocating a new array). This achieves a good balance between cache and branch-prediction. And the virtual machine is written entirely in C, which makes it faster than the Python above. <span class="anchor" id="line-55"></span><span class="anchor" id="line-56"></span><p class="line862">There is some more information and history at <a class="http" href="../../external.html?link=http://isobaric.blogspot.com/2006/03/numerical-expression-evaluator-now-in.html">http://isobaric.blogspot.com/2006/03/numerical-expression-evaluator-now-in.html</a>. <span class="anchor" id="line-57"></span><span class="anchor" id="line-58"></span><p class="line867">
<h2 id="Credits">Credits</h2>
<span class="anchor" id="line-59"></span><p class="line862">Numexpr was initially written by <a href="../DavidCooke.html">DavidCooke</a>, and extended to more types by <a class="nonexistent" href="../TimHochberg.html">TimHochberg</a>. <span class="anchor" id="line-60"></span><span class="anchor" id="line-61"></span><p class="line867">
<h2 id="See_also">See also</h2>
<span class="anchor" id="line-62"></span><span class="anchor" id="line-63"></span><ul><li><p class="line891"><a href="../Cookbook/Autovectorize.html">Cookbook/Autovectorize</a> <span class="anchor" id="line-64"></span></li><li><p class="line891"><a class="http" href="../../external.html?link=http://thread.gmane.org/gmane.comp.python.numeric.general/17266/focus=17280">Re: vectorizing loops - Discussion on scipy list</a> <span class="anchor" id="line-65"></span><span class="anchor" id="line-66"></span></li></ul><p class="line867"><hr /><p class="line874"> <span class="anchor" id="line-67"></span><ul><li style="list-style-type:none"><p class="line891"><a href="../CategorySciPyPackages.html">CategorySciPyPackages</a> <span class="anchor" id="line-68"></span></li></ul><span class="anchor" id="bottom"></span></div><p id="pageinfo" class="info" lang="en" dir="ltr">SciPy: SciPyPackages/NumExpr  (last edited 2015-10-24 17:48:24 by <span title="">anonymous</span>)</p>

<div id="pagebottom"></div>
</div>


<div id="footer">
<ul class="editbar"><li class="toggleCommentsButton" style="display:none;"><a href="#" class="nbcomment" onClick="toggleComments();return false;">Comments</a></li><li><a class="nbattachments" href="NumExpr37dc.html?action=AttachFile" rel="nofollow">Attachments</a></li><li>
<form class="actionsmenu" method="GET" action="../../external.html?link=http://localhost:8080/SciPyPackages/NumExpr">
<div>
    <label>More Actions:</label>
    <select name="action"
        onchange="if ((this.selectedIndex != 0) &&
                      (this.options[this.selectedIndex].disabled == false)) {
                this.form.submit();
            }
            this.selectedIndex = 0;">
        <option value="show" disabled class="disabled">------------------------</option>
<option value="show" disabled class="disabled">------------------------</option>
<option value="RenamePage" disabled class="disabled">Rename Page</option>
<option value="DeletePage" disabled class="disabled">Delete Page</option>
<option value="show" disabled class="disabled">------------------------</option>
<option value="show" disabled class="disabled">Subscribe User</option>
<option value="show" disabled class="disabled">------------------------</option>
<option value="show" disabled class="disabled">Remove Spam</option>
<option value="show" disabled class="disabled">Revert to this revision</option>
    </select>
    <input type="submit" value="Do">
    
</div>
<script type="text/javascript">
<!--// Init menu
actionsMenuInit('More Actions:');
//-->
</script>
</form>
</li></ul>

<ul id="credits">
<li><a href="../../external.html?link=http://moinmo.in/" title="This site uses the MoinMoin Wiki software.">MoinMoin Powered</a></li><li><a href="../../external.html?link=http://moinmo.in/Python" title="MoinMoin is written in Python.">Python Powered</a></li><li><a href="../../external.html?link=http://moinmo.in/GPL" title="MoinMoin is GPL licensed.">GPL licensed</a></li><li><a href="../../external.html?link=http://validator.w3.org/check?uri=referer" title="Click here to validate this page.">Valid HTML 4.01</a></li>
</ul>


</div>
</body>

<!-- Mirrored from localhost:8080/SciPyPackages/NumExpr?highlight=%28%28Weave%29%29 by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 29 Oct 2015 23:20:36 GMT -->
</html>

